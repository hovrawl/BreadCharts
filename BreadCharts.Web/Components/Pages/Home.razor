@page "/"
@using BreadCharts.Core.Models
@using BreadCharts.Core.Services
@using SpotifyAPI.Web
@using BreadCharts.Web.Components.Charts
@using BreadCharts.Web.Data
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.Authentication

@inject NavigationManager NavigationManager;
@inject ISpotifyClientService SpotifyClientService;
@inject UserManager<ApplicationUser> UserManager;
@inject IHttpContextAccessor HttpContextAccessor;

<PageTitle>Home</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Class="overflow-y">
    @if (authed)
    {
        <FluentStack>
            <p>Welcome @(username)!</p>
        </FluentStack>
        <ChartPicker/>
    }
    else
    {
        <p>Please sign in to continue. Redirecting...</p>
    }
    
</FluentStack>

@code {

    bool authed;
    bool loading = false;

    List<FullTrack> TrackOptions = new();
    List<ChartOption> ChartOptions = new();
    string selectedOption;
    string selectedChartOption;
    static string defaultResultsText = "no results";
    
    string username;
    
    protected override async Task OnInitializedAsync()
    {
        var context = HttpContextAccessor.HttpContext;
        authed = context?.User?.Identity?.IsAuthenticated == true;
        if (authed)
        {
            var user = await UserManager.GetUserAsync(context!.User);
            // Access/refresh tokens are session-only and kept in claims
            var access = context!.User.FindFirst("urn:spotify:access_token")?.Value;
            var refresh = context!.User.FindFirst("urn:spotify:refresh_token")?.Value;
            if (user is not null && !string.IsNullOrEmpty(access))
            {
                try
                {
                    var userProfile = await SpotifyClientService.GetUserProfile(user.Id, access!, refresh);
                    if (userProfile != null)
                    {
                        username = userProfile.Name;
                    }
                }
                catch
                {
                    // Token invalid/refresh failed, sign out and redirect to welcome
                    await HttpContextAccessor.HttpContext!.SignOutAsync(IdentityConstants.ApplicationScheme);
                    authed = false;
                    NavigationManager.NavigateTo("/welcome", replace: true);
                }
            }
        }
    }
}